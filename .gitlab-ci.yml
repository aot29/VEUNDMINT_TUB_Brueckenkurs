stages:
  - setup
  - build
  - test

cache:
  paths:
    - node_modules/
    - venv/

before_script:
  - "echo we are working in $CI_PROJECT_DIR"
  # runn ssh-agent (inside the build environment)

# setup_nvm:
#   stage: setup
#   script:
#     - "echo installing npm and phantomJS via nvm"
#     - "git clone https://github.com/creationix/nvm.git ~/.nvm && cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`"
#     - ". ~/.nvm/nvm.sh"
#     - "nvm install 5.0"
#     - "nvm use 5.0"
#     - "npm install"
#   artifacts:
#     name: "${CI_BUID_STAGE}_${CI_BUID_REF_NAME}"
#     paths:
#       - node_modules/

setup_python:
  stage: setup
  only:
    - develop_software
    - develop_gulp
  script:
    - "echo installing python dependencies in virtual environment"
    - "[ ! -d venv ] && virtualenv -p python3 venv"
    - "source venv/bin/activate"
    - "pip3 install -r requirements.txt"
  artifacts:
    name: "${CI_BUID_STAGE}_${CI_BUID_REF_NAME}"
    paths:
      - venv/

build_multilang:
  stage: build
  only:
    - develop_gulp
  script:
    - "[ ! -d tu9onlinekurstest ] && make -f tools/makefiles/multilang"
    - "rsync -i /Users/n/.ssh/can -avr --exclude '*.png' --exclude '*.mp4' tu9onlinekurstest/* mulfadmin@guest6.mulf.tu-berlin.de:/home/mulfadmin/gitlab-ci"

build_multilang_gulp:
  stage: build
  only:
    - develop_gulp
  script:
    - "[ ! -d tu9onlinekurstest ] && make -f tools/makefiles/multilang"
    - "gulp"
    - "rsync -avr --exclude '*.png' --exclude '*.mp4' public/* /home/mulfadmin/gitlab-ci"

all_tests_and_coverage:
  stage: test
  only:
    - develop_software
    - develop_gulp
  script:
    # taken from setup_nvm above for time optimization
    - "echo installing npm and phantomJS via nvm"
    - "git clone https://github.com/creationix/nvm.git ~/.nvm && cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`"
    - ". ~/.nvm/nvm.sh"
    - "nvm install 5.0"
    - "nvm use 5.0"
    - "npm install"
    # end
    - "source venv/bin/activate"
    - "export BASE_URL=http://guest6.mulf.tu-berlin.de/gitlab-ci/"
    - "export LC_ALL=en_US.UTF-8"
    - "export LANG=en_US.UTF-8"
    - "export LANGUAGE=en_US.UTF-8"
    - "green -vvv --run-coverage"
    - "coverage html"
    - "rsync -i /Users/n/.ssh/can -avr htmlcov/* mulfadmin@guest6.mulf.tu-berlin.de:/home/mulfadmin/gitlab-ci/coverage"
  artifacts:
    name: "${CI_BUID_STAGE}_${CI_BUID_REF_NAME}"
    paths:
      - src/test/htmlcov
  dependencies:
    - setup_python
    #    - setup_nvm
