function getObjName(){s="isobj_"+signature_main;logMessage(DEBUGINFO,"Loading user object with id "+s);return s}function createIntersiteObj(){logMessage(VERBOSEINFO,"New IntersiteObj created");var a={active:false,layout:{fontadd:0,menuactive:true},configuration:{stylecolor:STYLEBLUE},scores:[],sites:[],favorites:[createHelpFavorite()],history:{globalmillis:0,commits:[]},login:{type:0,vname:"",sname:"",username:"",password:"",email:""}};return a}function createIntersiteObjFromSCORM(a,h,b){logMessage(VERBOSEINFO,"New IntersiteObj for scormlogin created");var g=createIntersiteObj();g.login.type=1;g.login.vname="";var c=h.split(" ");for(var f=0;f<(c.length-1);f++){if(f!=0){g.login.vname+=" "}g.login.vname+=c[f]}g.login.sname=c[c.length-1];logMessage(VERBOSEINFO,"Decomposed name "+h+' into vname="'+g.login.vname+'", sname = "'+g.login.sname+'"');g.login.username=a;g.login.password=b;g.login.email="";g.startertitle=document.title;g.configuration.CF_LOCAL="1";g.configuration.CF_USAGE="1";g.configuration.CF_TESTS="1";return g}function check_user_scorm_success(a){logMessage(VERBOSEINFO,"checkuser_scorm success: data = "+JSON.stringify(a));if(a.user_exists==false){logMessage(VERBOSEINFO,"User does not exist, adding user to database with initial data push");userdata.addUser(true,intersiteobj.login.username,intersiteobj.login.password,undefined,register_success,register_error);intersiteobj.type=3}else{logMessage(VERBOSEINFO,"User is present in database, emitting data pull request");userdata.login(true,intersiteobj.login.username,intersiteobj.login.password,scormlogin_success,scormlogin_error)}}function check_user_scorm_error(a,b){logMessage(CLIENTERROR,"checkuser_scorm error:"+a+", data = "+JSON.stringify(b)+", trying backup from LocalStorage...")}function scormlogin_error(a,b){logMessage(CLIENTERROR,"Konnte user nicht am Server einloggen: "+a+", data = "+JSON.stringify(b));logMessage(CLIENTONLY,"Server nicht erreichbar, speichere Daten im Browser und aktualisiere Server sobald Verbindung wieder hergestellt ist");setIntersiteType(1)}function scormlogin_success(a){logMessage(VERBOSEINFO,"login success, data = "+JSON.stringify(a));if(a.status==false){scormlogin_error("Login gescheitert",null);return}logMessage(VERBOSEINFO,"Login ok, role = "+a.role);logMessage(VERBOSEINFO,"i-name = "+intersiteobj.login.username);userdata.getData(true,intersiteobj.login.username,scormdbread_success,scormdbread_error)}function scormdbread_error(a,b){logMessage(CLIENTERROR,"Konnte user-Daten nicht vom Server abfragen: "+a+", data = "+JSON.stringify(b));logMessage(CLIENTONLY,"Server nicht erreichbar, speichere Daten im Browser und aktualisiere Server sobald Verbindung wieder hergestellt ist");setIntersiteType(1);userdata.logout(true,scormlogout_success,scormlogout_error)}function scormdbread_success(a){logMessage(VERBOSEINFO,"data get success");if(a.status==false){scormdbread_error("Data get gescheitert",null);return}userdata.logout(true,scormlogout_success,scormlogout_error);globalloadHandler(a.data)}function scormlogout_success(a){logMessage(VERBOSEINFO,"logout success, data = "+JSON.stringify(a))}function scormlogout_error(a,b){logMessage(CLIENTERROR,"SCORM-Pull-Logout unmoeglich: "+a+", data = "+JSON.stringify(b))}function objClone(c){if(c==null||typeof(c)!="object"){return c}var a=c.constructor();if((typeof a)!="object"){logMessage(DEBUGINFO,"PROBLEM with object"+JSON.stringify(c))}for(var b in c){if(c.hasOwnProperty(b)){a[b]=objClone(c[b])}}return a}function SetupIntersite(t,p){logMessage(VERBOSEINFO,"SetupIntersite START");if(forceOffline==1){logMessage(CLIENTINFO,"Course is in OFFLINE mode")}var e="";if(p!=""){intersiteobj=JSON.parse(p);logMessage(VERBOSEINFO,"iso von pull geparsed, logintype = "+intersiteobj.login.type+", username = "+intersiteobj.login.username);logMessage(VERBOSEINFO,"Got an intersite object from "+intersiteobj.startertitle);intersiteactive=true}else{var l="";if(typeof(localStorage)!=="undefined"){localStoragePresent=true;logMessage(VERBOSEINFO,"localStorage found");if(doScorm==1){l=localStorage.getItem("LOCALSCORM")}}else{localStoragePresent=false;logMessage(CLIENTERROR,"localStorage NOT found");var r=window.localStorage;if(typeof(r)!=="undefined"){logMessage(CLIENTERROR,"window.localStorage as stor found!")}}if(doScorm==1){if((l=="")||(l=="CLEARED")){logMessage(VERBOSEINFO,"pipwerks.SCORM start")}else{var q=JSON.parse(l);if(q!=null){pipwerks.scormdata=q;logMessage(VERBOSEINFO,"pipwerks.SCORM continuation")}else{logMessage(VERBOSEINFO,"pipwerks.SCORM-Uebertragungsobjekt beschaedigt")}}}if((scormLogin==1)&&(SITE_PULL==1)){logMessage(VERBOSEINFO,"SCORM-pull forciert (SITE_PULL = "+SITE_PULL+")");var c=pipwerks.SCORM.init();logMessage(VERBOSEINFO,"SCORM init = "+c+" (remember duplicate SCORM inits return false but do not hurt)");c=pipwerks.SCORM.get("cmi.learner_id");if(c=="null"){alert("Kommunikation der Lernplattform fehlgeschlagen, Kurs kann nur anonym bearbeitet werden!");intersiteobj=createIntersiteObj();intersiteobj.active=true;intersiteobj.startertitle=document.title;intersiteobj.configuration.CF_LOCAL="0";intersiteobj.configuration.CF_USAGE="0";intersiteobj.configuration.CF_TESTS="0";intersiteactive=true;logMessage(CLIENTERROR,"Intersite setup WITHOUT STORAGE AND WITHOUT SCORM from scratch from "+intersiteobj.startertitle)}else{var h=c;logMessage(VERBOSEINFO,"SCORM learner id = "+c);c=pipwerks.SCORM.get("cmi.learner_name");var w=c;logMessage(VERBOSEINFO,"SCORM learner name = "+c);c=pipwerks.SCORM.save();logMessage(DEBUGINFO,"SCORM save = "+c);e=signature_CID+"_SCORM_"+h;logMessage(DEBUGINFO,"Assigned login name = "+e);intersiteobj=createIntersiteObjFromSCORM(e,w,"scpw"+h);intersiteobj.active=true;intersiteactive=true;logMessage(VERBOSEINFO,"Intersite setup from SCORM: "+e);var b=+new Date();var m="SCORMLOGIN_PULL: CID:"+signature_CID+", user:"+intersiteobj.login.username+", timestamp:"+b+", browsertype:"+navigator.appName+", browserid:"+navigator.userAgent;logMessage(VERBOSEINFO,"Emitting pull request for this user!");userdata.checkUser(true,intersiteobj.login.username,check_user_scorm_success,check_user_scorm_error);logMessage(VERBOSEINFO,"Pull request send")}}else{if(localStoragePresent==false){intersiteobj=createIntersiteObj();intersiteobj.active=true;intersiteobj.startertitle=document.title;intersiteobj.configuration.CF_LOCAL="0";intersiteobj.configuration.CF_USAGE="0";intersiteobj.configuration.CF_TESTS="0";intersiteactive=true;logMessage(CLIENTERROR,"Intersite setup WITHOUT STORAGE from scratch from "+intersiteobj.startertitle)}else{var y=localStorage.getItem(getObjName());logMessage(VERBOSEINFO,"iso aus localStorage geholt");if(t==true){if(intersiteactive==true){if(intersiteobj.configuration.CF_USAGE=="1"){var b=+new Date();var m="USERRESET: CID:"+signature_CID+", user:"+intersiteobj.login.username+", timestamp:"+b;sendeFeedback({statistics:m},true)}}y=null;logMessage(VERBOSEINFO,"Userreset verlangt")}if(y==""){y=null;logMessage(VERBOSEINFO,'iso = "" auf null gesetzt')}if(y==null){intersiteobj=createIntersiteObj();intersiteobj.active=true;intersiteobj.startertitle=document.title;intersiteobj.configuration.CF_LOCAL="1";intersiteobj.configuration.CF_USAGE="1";intersiteobj.configuration.CF_TESTS="1";intersiteactive=true;logMessage(VERBOSEINFO,"Intersite setup with local storage from scratch from "+intersiteobj.startertitle);if((intersiteobj.configuration.CF_USAGE=="1")&&(t==false)){var b=+new Date();var m="INTERSITEFIRST: CID:"+signature_CID+", user:"+intersiteobj.login.username+", timestamp:"+b+", browsertype:"+navigator.appName+", browserid:"+navigator.userAgent;sendeFeedback({statistics:m},true)}}else{intersiteobj=JSON.parse(y);logMessage(VERBOSEINFO,"iso geparsed, logintype = "+intersiteobj.login.type+", username = "+intersiteobj.login.username);logMessage(VERBOSEINFO,"Got an intersite object from "+intersiteobj.startertitle);intersiteactive=true}}}}if(intersiteactive==true){if((intersiteobj.login.type==2)||(intersiteobj.login.type==3)){logMessage(VERBOSEINFO,"Type=2,3, serverget missing")}}else{alert("Ihre Benutzerdaten konnten nicht vom Server geladen werden, eine automatische eMail an den Administrator wurde verschickt. Sie können den Kurs trotzdem anonym bearbeiten, eingetragene Lösungen werden jedoch nicht gespeichert!");var b=+new Date();var o="(unknown)";if(scormLogin==1){o=e}var m="LOGINERROR: CID:"+signature_CID+", user:"+o+", timestamp:"+b+", browsertype:"+navigator.appName+", browserid:"+navigator.userAgent;sendeFeedback({statistics:m},true);intersiteobj=createIntersiteObj();intersiteobj.active=true;intersiteobj.startertitle=document.title;intersiteobj.configuration.CF_LOCAL="1";intersiteobj.configuration.CF_USAGE="1";intersiteobj.configuration.CF_TESTS="1";intersiteactive=true}if((intersiteactive==true)&&(SITE_UXID!="(unknown)")){if(intersiteobj.configuration.CF_USAGE=="1"){var x=false;var v=0;var g="SITE_"+SITE_UXID;if(typeof(intersiteobj.sites)=="undefined"){intersiteobj.sites=[]}for(v=0;v<intersiteobj.sites.length;v++){if(intersiteobj.sites[v].uxid==g){x=true;intersiteobj.sites[v].maxpoints=1;intersiteobj.sites[v].points=1;intersiteobj.sites[v].id=SITE_ID;intersiteobj.sites[v].intest=isTest;intersiteobj.sites[v].section=SECTION_ID;logMessage(VERBOSEINFO,"Points for site "+g+" modernized")}}if(x==false){var u=intersiteobj.sites.length;intersiteobj.sites[u]={uxid:g};intersiteobj.sites[u].millis=0;intersiteobj.sites[u].maxpoints=1;intersiteobj.sites[u].points=1;intersiteobj.sites[u].id=SITE_ID;intersiteobj.sites[u].intest=isTest;intersiteobj.sites[u].section=SECTION_ID;logMessage(VERBOSEINFO,"Points for site "+g+" ADDED at position "+u)}}}UpdateSpecials();confHandlerISOLoad();if(intersiteactive){updateCommits(intersiteobj)}updateLoginfield();if(intersitelinks!=true){var a=document.getElementsByClassName("MINTERLINK");for(i=0;i<a.length;i++){a[i].onclick=function(){opensite(this.href);return false}}intersitelinks=true}if(t==true){pushISO(false);ulreply_set(false,"")}}function updateLoginfield(){var p="";var m="#FFFFFF";if(intersiteactive==true){switch(intersiteobj.login.type){case 0:p="Kein Benutzer angemeldet";m="#E01010";$("#loginbutton").css("background-color","#FF5050");break;case 1:p="Benutzer "+intersiteobj.login.username+" ("+intersiteobj.login.vname+" "+intersiteobj.login.sname+"), nicht am Server angemeldet";m="#FFFF10";$("#loginbutton").css("background-color","#FFFF50");break;case 2:p="Benutzer "+intersiteobj.login.username+" ("+intersiteobj.login.vname+" "+intersiteobj.login.sname+") ist am Server angemeldet";m="#FFFFFF";$("#loginbutton").css("background-color",$("#cdatabutton").css("background-color"));break;case 3:p="Benutzer "+intersiteobj.login.username+" ("+intersiteobj.login.vname+" "+intersiteobj.login.sname+") ist am Server angemeldet";m="#FFFFFF";$("#loginbutton").css("background-color",$("#cdatabutton").css("background-color"));break;default:logMessage(CLIENTERROR,"updateLoginfield, wrongtype="+intersiteobj.login.type);p="Keine Anmeldung möglich!";break}}$("#LOGINROW").css("color",m);$("#LOGINROW").html(p);c=document.getElementById("ONLYLOGINFIELD");if(c!=null){logMessage(VERBOSEINFO,"Einlogfeld gefunden");if(intersiteactive==true){c.innerHTML=p+"<br /><br />";c.innerHTML+='<table> <tr><td align=left>Benutzername:</td><td align=left><input id="OUSER_LOGIN" type="text" size="18"></input></td></tr><tr><td align=left>Passwort:</td><td align=left><input id="OUSER_PW" type="password" size="18"></input></td></tr></table><br /><button type ="button" onclick="userlogin_click();">Benutzer anmelden</button>';c=document.getElementById("OUSER_LOGIN");if(c!=null){c.style.backgroundColor="#D0D0D0";if((intersiteobj.login.type==2)||(intersiteobj.login.type==3)){c.value=intersiteobj.login.username}}c=document.getElementById("OUSER_PW");if(c!=null){c.style.backgroundColor="#D0D0D0"}}else{logMessage(CLIENTERROR,"Login mangels intersite nicht moeglich")}}c=document.getElementById("RESETBUTTON");if(c!=null){var a=true;if(intersiteactive==true){if(intersiteobj.configuration.CF_LOCAL=="1"){a=false}}c.disabled=a}var c=document.getElementById("LOGINFIELD");if(c!=null){var p="";if(intersiteactive==true){if(intersiteobj.login!=null){var h="";if((intersiteactive==true)&&(intersiteobj.configuration.CF_LOCAL=="1")){h="Datenspeicherung nur in diesem Browser und diesem Rechner."}else{h="Es werden keine Kursdaten gespeichert."}var o=intersiteobj.login.type;var f=document.getElementById("CREATEBUTTON");var l=document.getElementById("USERNAMEFIELD");var b;if(scormLogin==0){b="Benutzername: "+intersiteobj.login.username+" ("+intersiteobj.login.vname+" "+intersiteobj.login.sname+")"}else{b="Benutzer: "+intersiteobj.login.vname+" "+intersiteobj.login.sname}switch(o){case 0:p="Noch keine Benutzerdaten vorhanden, Kurs wird anonym bearbeitet,<br />"+h;if(f!=null){f.disabled=false}if(l!=null){l.style.display="inline"}break;case 1:p=b+",<br />"+h;if(f!=null){f.disabled=true}if(l!=null){l.style.display="none"}break;case 2:p=b+",<br />Datenspeicherung in diesem Browser und auf Server ";if(f!=null){f.disabled=true}if(l!=null){l.style.display="none"}break;case 3:p=b+",<br />Datenspeicherung in diesem Browser und auf Server ";if(f!=null){f.disabled=true}if(l!=null){l.style.display="none"}break;default:p="Anmeldevorgang gescheitert!";c.style.color="#FF1111";break}if((o==2)||(o==3)){p+=feedbackdesc}if(o!=0){var g=document.getElementById("USER_UNAME");if(g!=null){g.value=intersiteobj.login.username;g.style.backgroundColor="#70FFFF"}g=document.getElementById("USER_PW");if(g!=null){g.value=intersiteobj.login.password;g.style.backgroundColor="#70FFFF"}g=document.getElementById("USER_VNAME");if(g!=null){g.value=intersiteobj.login.vname;g.style.backgroundColor="#70FFFF"}g=document.getElementById("USER_SNAME");if(g!=null){g.value=intersiteobj.login.sname;g.style.backgroundColor="#70FFFF"}g=document.getElementById("USER_EMAIL");if(g!=null){g.value=intersiteobj.login.email;g.style.backgroundColor="#70FFFF"}}else{var g=document.getElementById("USER_UNAME");if(g!=null){g.value="";g.style.backgroundColor="#E0E3E0"}g=document.getElementById("USER_PW");if(g!=null){g.value="";g.style.backgroundColor="#E0E3E0"}g=document.getElementById("USER_VNAME");if(g!=null){g.value="";g.style.backgroundColor="#E0E3E0"}g=document.getElementById("USER_SNAME");if(g!=null){g.value="";g.style.backgroundColor="#E0E3E0"}g=document.getElementById("USER_EMAIL");if(g!=null){g.value="";g.style.backgroundColor="#E0E3E0"}}}else{p="Keine Anmeldedaten gefunden!"}}else{p="Keine Anmeldedaten im Browser gespeichert!"}c.style.color="#000000";c.innerHTML=p;logMessage(VERBOSEINFO,"Userfield gesetzt")}}function UpdateSpecials(){var h=document.getElementById("FAVORITELISTLONG");if(h!=null){if((intersiteactive==true)&&(intersiteobj.configuration.CF_LOCAL=="0")){h.innerHTML="Datenspeicherung wurde durch Benutzer deaktiviert, es werden keine Kursdaten gespeichert."}else{h.innerHTML=((intersiteactive==true)&&(localStoragePresent==true))?generateLongFavoriteList():"Der Browser kann keine lokalen Daten speichern, Eingaben in Aufgabenfeldern werden nicht gespeichert."}}var h=document.getElementById("CHECKIS");if(h!=null){if((intersiteactive==true)&&(intersiteobj.configuration.CF_LOCAL=="0")){h.innerHTML="Datenspeicherung wurde durch Benutzer deaktiviert, es werden keine Kursdaten gespeichert."}else{var g=JSON.stringify(intersiteobj);h.innerHTML=((intersiteactive==true)&&(localStoragePresent==true))?("Der Browser kann die Kursdaten speichern,\nes werden momentan "+g.length+" Bytes durch Kursdaten belegt."):"Der Browser kann keine lokalen Daten speichern, Eingaben in Aufgabenfeldern werden nicht gespeichert."}}var h=document.getElementById("OBJOUT");if(h!=null){h.value=JSON.stringify(intersiteobj)}var h=document.getElementById("OBJARRAYS");if(h!=null){if(intersiteactive==true){h.value="SITES:\n";var c=0;for(c=0;c<intersiteobj.sites.length;c++){h.value+=intersiteobj.sites[c].uxid+"\n"}h.value+="\nSCORES:\n";var c=0;for(c=0;c<intersiteobj.scores.length;c++){h.value+=intersiteobj.scores[c].siteuxid+"->"+intersiteobj.scores[c].uxid+": "+intersiteobj.scores[c].points+"/"+intersiteobj.scores[c].maxpoints+"\n"}}}var h=document.getElementById("CDATAS");if(h!=null){if((intersiteactive==true)&&(intersiteobj.configuration.CF_LOCAL=="0")){h.innerHTML="Datenspeicherung wurde durch Benutzer deaktiviert, es werden keine Kursdaten gespeichert."}else{if((intersiteactive==true)&&(localStoragePresent==true)){var o="";var a=[];var m=[];var f=[];for(k=0;k<globalexpoints.length;k++){a[k]=0;m[k]=0;f[k]=0;var b=0;for(b=0;b<intersiteobj.scores.length;b++){if((intersiteobj.scores[b].section==(k+1))&&(intersiteobj.scores[b].siteuxid.slice(0,6)!="VBKMT_")){a[k]+=intersiteobj.scores[b].points;if(intersiteobj.scores[b].intest==true){m[k]+=intersiteobj.scores[b].points}}}for(b=0;b<intersiteobj.sites.length;b++){if(intersiteobj.sites[b].section==(k+1)){f[k]+=intersiteobj.sites[b].points}}o+="<strong>Kapitel "+(k+1)+": "+globalsections[k]+"</strong><br />";o+="Insgesamt "+f[k]+" von "+globalsitepoints[k]+" Lerneinheiten des Moduls besucht.<br />";o+="<progress id='slidebar0_"+k+"' value='"+f[k]+"' max='"+globalsitepoints[k]+"'></progress><br />";o+="Insgesamt "+a[k]+" von "+globalexpoints[k]+" Punkten der Aufgaben erreicht.<br />";o+="<progress id='slidebar1_"+k+"' value='"+a[k]+"' max='"+globalexpoints[k]+"'></progress><br />";o+="Insgesamt "+m[k]+" von "+globaltestpoints[k]+" Punkten im Abschlusstest erreicht.<br />";o+="<progress id='slidebar2_"+k+"' value='"+m[k]+"' max='"+globaltestpoints[k]+"'></progress><br />";var l=m[k]/globaltestpoints[k];if(l<0.9){o+="<span style='color:#E00000'>Abschlusstest ist noch nicht bestanden.</span>"}else{o+="<span style='color:#00F000'>Abschlusstest ist BESTANDEN.</span>"}o+="<br /><br />"}h.innerHTML=o}else{h.innerHTML="Der Browser kann keine lokalen Daten speichern, Eingaben in Aufgabenfeldern werden nicht gespeichert. Modifizieren Sie ggf. die Auswahl auf der Einstellungsseite."}}}}function pushlogin_s_success(a){logMessage(VERBOSEINFO,"login success, data = "+JSON.stringify(a));if(a.status==false){pushlogin_error("Login gescheitert",null);return}logMessage(VERBOSEINFO,"Login ok, role = "+a.role);var b=JSON.stringify(intersiteobj);userdata.writeData(false,intersiteobj.login.username,b,pushwrite_success,pushwrite_error)}function pushlogin_success(a){logMessage(VERBOSEINFO,"login success, data = "+JSON.stringify(a));if(a.status==false){pushlogin_error("Login gescheitert",null);return}logMessage(VERBOSEINFO,"Login ok, role = "+a.role);var b=JSON.stringify(intersiteobj);userdata.writeData(true,intersiteobj.login.username,b,pushwrite_success,pushwrite_error)}function pushlogin_error(a,b){logMessage(CLIENTERROR,"Konnte Daten nicht auf Server ablegen: "+a+", data = "+JSON.stringify(b));logMessage(CLIENTONLY,"Server nicht erreichbar, speichere Daten im Browser und aktualisiere Server sobald Verbindung wieder hergestellt ist");setIntersiteType(3)}function pushlogout_success(a){logMessage(VERBOSEINFO,"pushlogout success")}function pushlogout_error(a,b){logMessage(VERBOSEINFO,"pushlogout error: "+a+", data = "+JSON.stringify(b))}function pushwrite_success(a){logMessage(VERBOSEINFO,"pushwrite success, data = "+JSON.stringify(a));setIntersiteType(2);userdata.logout(false,pushlogout_success,pushlogout_error)}function pushwrite_error(a,b){logMessage(VERBOSEINFO,"pushwrite error: "+a+", data = "+JSON.stringify(b)+", versuche logout...");userdata.logout(false,pushlogout_success,pushlogout_error)}function pushISO(b){logMessage(VERBOSEINFO,"pushISO start (synced = "+b+")");var a=JSON.stringify(intersiteobj);if(localStoragePresent==true){if(doScorm==1){localStorage.setItem("LOCALSCORM",JSON.stringify(pipwerks.scormdata));logMessage(VERBOSEINFO,"Aktualisiere SCORM Uebertragungsobjekt")}localStorage.setItem(getObjName(),a);if((intersiteobj.login.type==2)||(intersiteobj.login.type==3)){logMessage(VERBOSEINFO,"Aktualisiere DB-Server (synced = "+b+")");if(b){userdata.login(false,intersiteobj.login.username,intersiteobj.login.password,pushlogin_s_success,pushlogin_error)}else{userdata.login(true,intersiteobj.login.username,intersiteobj.login.password,pushlogin_success,pushlogin_error)}}}updateLoginfield();logMessage(VERBOSEINFO,"pushISO finish")}function opensite(c){if(intersiteactive==true){if(intersiteobj.configuration.CF_USAGE=="1"){var b=+new Date();var a="OPENSITE: CID:"+signature_CID+", user:"+intersiteobj.login.username+", timestamp:"+b+", SITEUXID:"+SITE_UXID+", localurl:"+c;sendeFeedback({statistics:a},false)}}window.open(c,"_self")}function sendCorsRequest(b,e,f,a,c){logMessage(VERBOSEINFO,"intersite.sendCorsRequest called, type = POST, url = "+b+", async = "+c+", data = "+JSON.stringify(e));if(forceOffline==1){logMessage(VERBOSEINFO,"Send request omittet, course is in offline mode")}$.ajax(b,{type:"POST",async:c,cache:false,contentType:"application/x-www-form-urlencoded",crossDomain:true,data:e,error:a,success:f})}var feedbackLog=[];function sendeFeedback(b,a){if(feedback_service!=""){sendCorsRequest(feedback_service,b,function(c){logMessage(VERBOSEINFO,"SendeFeedback success callback: "+JSON.stringify(c));feedbackLog.push({success:true,status:c,feedback:b,timestamp:(new Date).getTime()})},function(c,f,e){logMessage(VERBOSEINFO,"SendeFeedback error callback: "+f+", thrown: "+JSON.stringify(e));feedbackLog.push({success:false,status:f,feedback:b,timestamp:(new Date).getTime()})},a)}}function confHandlerChange(f){var a=document.getElementById(f);if((a!=null)&&(intersiteactive==true)){var b=a.checked;if(intersiteobj.active==true){if((intersiteobj.configuration.CF_LOCAL=="1")&&(f=="CF_LOCAL")&&(b==false)){if(confirm("Ohne lokale Datenspeicherung gehen die Benutzer- und Kursdaten verloren. Trotzdem ohne Datenspeicherung fortfahren?")==false){b=1;a.checked=true}}switch(f){case"CF_LOCAL":intersiteobj.configuration.CF_LOCAL=(b)?"1":"0";break;case"CF_USAGE":intersiteobj.configuration.CF_USAGE=(b)?"1":"0";break;case"CF_TESTS":intersiteobj.configuration.CF_TESTS=(b)?"1":"0";break}}pushISO(false);UpdateSpecials();updateLoginfield()}}function confHandlerISOLoad(){if(intersiteactive==true){if(intersiteobj.active==true){var a;a=document.getElementById("CF_LOCAL");if(a!=null){a.checked=(intersiteobj.configuration.CF_LOCAL=="1")?true:false}a=document.getElementById("CF_USAGE");if(a!=null){a.checked=(intersiteobj.configuration.CF_USAGE=="1")?true:false}a=document.getElementById("CF_TESTS");if(a!=null){a.checked=(intersiteobj.configuration.CF_TESTS=="1")?true:false}}}}function userlogin_click(){logMessage(VERBOSEINFO,"userlogin geklickt");var a="";var c="";var f=document.getElementById("OUSER_LOGIN");if(f!=null){a=f.value}else{return}f=document.getElementById("OUSER_PW");if(f!=null){c=f.value}else{return}var b=allowedUsername(a);if(b!=""){alert(b);return}b=allowedPassword(c);if(b!=""){alert(b);return}logMessage(VERBOSEINFO,"Starte Login "+a);userdata.login(true,a,c,userlogin_success,userlogin_error)}function userlogin_success(a){logMessage(VERBOSEINFO,"userlogin success");if(a.status==false){userlogin_error("Login gescheitert",null);return}logMessage(VERBOSEINFO,"Login ok, username = "+a.username+", role = "+a.role);userdata.getData(true,undefined,loginread_success,loginread_error)}function userlogin_error(a,b){if(typeof(b)=="object"){if(b.error=="invalid password"){alert("Benutzername oder Passwort sind nicht korrekt, bitte versuchen Sie es nochmal.");logMessage(VERBOSEINFO,"Login wegen fehlerhaftem Benutzernamen/Passwort nicht akzeptiert");return}}logMessage(CLIENTERROR,"Login gescheitert: "+a+", data = "+JSON.stringify(b))}function loginread_success(b){if(b.status==false){logMessage(VERBOSEINFO,"login read successm but status error: "+b.error);return}logMessage(VERBOSEINFO,"loginread success");var a=JSON.parse(b.data);logMessage(VERBOSEINFO,"iso = "+JSON.stringify(a));intersiteobj=a;setIntersiteType(2);userdata.logout(true,pushlogout_success,pushlogout_error)}function loginread_error(a,b){logMessage(CLIENTERROR,"loginread error: "+a+", data = "+JSON.stringify(b)+", trying logout...");logMessage(CLIENTONLY,"Konnte Benutzerdaten nicht von Server uebertragen!");userdata.logout(true,pushlogout_success,pushlogout_error)}function userreset_click(){logMessage(VERBOSEINFO,"userreset_click");var a="Wirklich alle Benutzer- und Kursdaten ";if(intersiteactive==true){if(intersiteobj.config!=null){if(intersiteobj.config.type>0){a+="(Benutzername "+intersiteobj.config.username+") "}}}a+="löschen? Dieser Vorgang kann nicht rückgängig gemacht werden!";if(confirm(a)==true){SetupIntersite(true)}}function allowedUsername(a){if((a.length<6)||(a.length>18)){return"Der Loginname muss mindestens 6 und höchstens 18 Zeichen enthalten"}if(RegExp("[^a-z0-9\\-\\+_]","i").test(a)){return"Im Loginnamen sind nur lateinische Buchstaben und Zahlen sowie die Sonderzeichen _ - + erlaubt."}return""}function allowedPassword(a){if((a.length<6)||(a.length>18)){return"Das Passwort muss mindestens 6 und höchstens 18 Zeichen enthalten"}if(RegExp("[^a-z0-9\\-\\+_]","i").test(a)){return"Im Passwort sind nur lateinische Buchstaben und Zahlen sowie die Sonderzeichen _ - + erlaubt."}return""}function usercreatelocal_click(l){if(l==2){alert("In der Korrekturversion ist das Anlegen eines Netz-Benutzers nicht möglich um eine Verzerrung der Aufgaben- und Nutzerdatenauswertung zu vermeiden, bitte registrieren Sie sich nur innerhalb Ihres Browsers mit dem Button unten.");return}if(intersiteactive==false){alert("Keine Datenspeicherung möglich, kann Benutzer nicht anlegen!");return}if(intersiteobj.configuration.CV_LOCAL=="0"){alert("Keine Datenspeicherung möglich, lokale Datenspeicherung muss zuerst in den Einstellungen aktiviert werden.");return}var g=document.getElementById("USER_UNAME");var b=document.getElementById("USER_VNAME");var c=document.getElementById("USER_SNAME");var a=document.getElementById("USER_EMAIL");var o=g.value;var e=allowedUsername(o);if(e!=""){alert(e);return}var p="";if(4==4){}else{p=prompt("Geben Sie ein Passwort für den Benutzer "+o+" ein:");if(p==null){return}e=allowedPassword(p);if(e!=""){alert(e);return}var f=prompt("Geben Sie das Passwort zur Sicherheit nochmal ein:");if(f==null){return}if(f!=p){alert("Die Passwörter stimmen nicht überein.");return}}logMessage(CLIENTINFO,"User set to local for username "+o);logMessage(CLIENTINFO,"User was previously on type="+intersiteobj.login.type);setIntersiteType(1);intersiteobj.login.username=o;intersiteobj.login.password=p;intersiteobj.login.vname=b.value;intersiteobj.login.sname=c.value;intersiteobj.login.email=a.value;updateLoginfield();logMessage(VERBOSEINFO,"Neuen Benutzer "+intersiteobj.login.username+" angelegt.");if(intersiteobj.configuration.CF_USAGE=="1"){var h=+new Date();var m="USERCREATE: CID:"+signature_CID+", user:"+o+", timestamp:"+h+", browsertype:"+navigator.appName+", browserid:"+navigator.userAgent;sendeFeedback({statistics:m},true)}if(l==2){logMessage(CLIENTINFO,"Benutzer wird auf Typ 2 erweitert");userdata.addUser(true,intersiteobj.login.username,intersiteobj.login.password,undefined,register_success,register_error)}}function register_success(e){logMessage(VERBOSEINFO,"Register success, data = "+JSON.stringify(e));var b;b=(scormLogin==1)?(intersiteobj.login.sname):(intersiteobj.login.username);if(e.status==true){setIntersiteType(3);pushISO(false);if(intersiteobj.configuration.CF_USAGE=="1"){var c=+new Date();var a="USERREGISTER: CID:"+signature_CID+", user:"+intersiteobj.login.username+", timestamp:"+c+", browsertype:"+navigator.appName+", browserid:"+navigator.userAgent;sendeFeedback({statistics:a},true)}}else{if(intersiteobj.configuration.CF_USAGE=="1"){var c=+new Date();var a="USERREGISTERERROR: CID:"+signature_CID+", user:"+una+", timestamp:"+c+", browsertype:"+navigator.appName+", browserid:"+navigator.userAgent+", data="+JSON.stringify(e);sendeFeedback({statistics:a},true)}setIntersiteType(1);if(e.error=="user already exists"){alert("Benutzer "+b+" existiert schon auf dem Server, bitte geben Sie einen neuen Benutzernamen ein.")}else{alert("Benutzer "+b+" konnte nicht angelegt werden, versuchen Sie es zu einem anderen Zeitpunkt nochmal. Der Benutzer wird nur im Browser angelegt.")}}}function register_error(b,c){logMessage(VERBOSEINFO,"Register error: "+b+", data = "+JSON.stringify(c));var a;a=(scormLogin==1)?(intersiteobj.login.sname):(intersiteobj.login.username);alert("Benutzer "+a+" konnte nicht angelegt oder der Server nicht erreicht werden, versuchen Sie es zu einem anderen Zeitpunkt nochmal. Der Benutzer wird nur im Browser angelegt.");setIntersiteType(1)}function check_user_success(a){logMessage(VERBOSEINFO,"checkuser success");var b=document.getElementById("USER_UNAME");if(b==null){logMessage(VERBOSEINFO,"USER_UNAME-Feld nicht gefunden");return}if((a.action=="check_user")&&(a.status==true)){if(a.user_exists==true){ulreply_set(false,"Benutzername ist schon vergeben.")}else{ulreply_set(true,"Dieser Benutzername ist verfügbar! <button type='button' style='background: #00FF00' onclick='usercreatelocal_click(2);'>Jetzt registrieren</button>")}}else{logMessage(VERBOSEINFO,"checkuser success, status=false, data = "+JSON.stringify(a));ulreply_set(false,"Kommunikation mit Server ("+feedbackdesc+") nicht möglich.")}}function check_user_error(a,b){logMessage(VERBOSEINFO,"checkuser error:"+a+", data = "+JSON.stringify(b));ulreply_set(false,"Kommunikation mit Server ("+feedbackdesc+") nicht möglich.")}function ulreply_set(b,a){var f;if(b==false){var c="../../images/false.png";f=document.getElementById("USER_UNAME");if(f==null){return}else{if(f.value==""){f.style.backgroundColor=QCOLOR_NEUTRAL;c="../../images/questionmark.png"}else{f.style.backgroundColor=QCOLOR_FALSE}}f=document.getElementById("checkuserimg");if(f==null){return}else{f.src=c}}else{f=document.getElementById("USER_UNAME");if(f==null){return}else{f.style.backgroundColor=QCOLOR_TRUE}f=document.getElementById("checkuserimg");if(f==null){return}else{f.src="../../images/right.png"}}f=document.getElementById("ulreply_p");if(f==null){return}else{f.innerHTML=a}}function usercheck(){var c=document.getElementById("USER_UNAME");if(c==null){logMessage(DEBUGINFO,"USER_UNAME-Feld nicht gefunden");return}var b=c.value;var a=allowedUsername(b);if(a!=""){ulreply_set(false,a);return}userdata.checkUser(true,b,check_user_success,check_user_error)}function setIntersiteType(a){logMessage(VERBOSEINFO,"Set type="+a);if(intersiteactive==true){intersiteobj.login.type=a}else{logMessage(DEBUGINFO,"intersiteactive == false")}}function convertTimestamp(a){date=new Date(a),d=[date.getUTCFullYear(),date.getUTCMonth()+1,date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds()];for(j=0;j<d.length;j++){d[j]=""+d[j];if(d[j].length==1){d[j]="0"+d[j]}}return d[2]+"."+d[1]+"."+d[0]+" - "+d[3]+":"+d[4]+":"+d[5]}function getTimestamp(){if(!Date.now){Date.now=function(){return new Date().getTime()}}return Date.now()}function updateCommits(f){var e=getTimestamp();var b="CHEX:"+signature_git_commit+"_CID:"+signature_CID;var a;var c=false;for(a=0;((a<f.history.commits.length)&&(!c));a++){if(f.history.commits[a][0]==b){c=true;f.history.commits[a][2]=e}}if(!c){n=f.history.commits.length;f.history.commits[n]=[b,e,e]}logMessage(DEBUGINFO,"Commit history:");for(a=0;a<f.history.commits.length;a++){logMessage(DEBUGINFO,"  "+f.history.commits[a][0]+", "+convertTimestamp(f.history.commits[a][1])+", "+convertTimestamp(f.history.commits[a][2]))}}function createHelpFavorite(){var a={type:"Tipp",color:"00FF00",text:"Eingangstest probieren",pid:"?",icon:"test01.png"};logMessage(VERBOSEINFO,"New HelpFavorite created");return a}function generateShortFavoriteList(){if(intersiteactive==false){return"Datenspeicherung nicht möglich"}if(typeof(intersiteobj.favorites)!="object"){intersiteobj.favorites=new Array()}var a;var b="";for(a=0;a<intersiteobj.favorites.length;a++){b+='<img src="'+linkPath+"images/"+intersiteobj.favorites[a].icon+'" style="width:20px;height:20px">&nbsp;&nbsp;';b+='<a href="" >'+intersiteobj.favorites[a].text+"</a><br />"}return b}function generateLongFavoriteList(){if(intersiteactive==false){return"Datenspeicherung nicht möglich"}if(typeof(intersiteobj.favorites)!="object"){intersiteobj.favorites=new Array()}var a;var b="";for(a=0;a<intersiteobj.favorites.length;a++){b+='<img src="'+linkPath+"images/"+intersiteobj.favorites[a].icon+'" style="width:48px;height:48px">&nbsp;&nbsp;';b+='<a href="" >'+intersiteobj.favorites[a].text+"</a><br />"}return b};