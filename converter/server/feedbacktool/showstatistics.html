<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Feedbacktool VEUNDMINT showstatistics</title>
</head>
<body>

    <script src="jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="es5-sham.min.js" type="text/javascript"></script>
    <script src="json2.js" type="text/javascript"></script>

    <h1>Feedbacktool</h1>

    content-String-Kürzel: <input name='N_kuerzel' id='I_kuerzel' type='text' size='50' maxlength='50' /> 
    <br /><br />
    Admin-Passwort: <input name='N_pw' id='I_pw' type='text' size='12' maxlength='12' /> 
    <br /><br />
    <button name="N_compute" id="I_compute" type="button" onclick="compute(1);">Einträge suchen</button>
    <br /><br />
    <button name="N_compute2" id="I_compute2" type="button" onclick="compute(2);">Erstanmeldungen listen</button>
    <br /><br />
    <button name="N_compute3" id="I_compute2" type="button" onclick="compute(3);">Auswertung MatheV4_WS20152016</button>
    <br /><br />
    <br /><br />
    <textarea name="N_output" id="I_output" rows="50" cols="150" style="background-color:#E0EAEA"></textarea>


    <script language="javascript" type="text/javascript">
        var server_name = "http://mintlx3.scc.kit.edu";
        var call_name = "/dbtest/showdata.php";
        var callurl = server_name + call_name;
    
        var results = "";
    
        var comp_mode = 1;
        var beforetime = +new Date();
        var aftertime = +new Date();
        var jetzt = new Date();
        var heute = jetzt.getDate() + "." + (jetzt.getMonth()+1) + "." + jetzt.getFullYear() + "+" + jetzt.getHours() + ":" + jetzt.getMinutes() + ":" + jetzt.getSeconds();
        // document.getElementById("I_LogLevel").value = "10";
        document.getElementById("I_kuerzel").value = "OPENSITE";
        document.getElementById("I_output").readOnly = true;

        function parse(s) {
          
          result = s;
          
          
          if (comp_mode == 2) {
            var tob = new Array();
            var rex = /id: (\d+), timestamp: (\d\d\d\d-\d\d-\d\d) \d\d:\d\d:\d\d, content: INTERSITEFIRST/g ;
            var u;
            result = "";
            var i = 0;
            while ( (u = rex.exec(s)) != null) {
              var found = false;
              for (i = 0; ((i < tob.length) & (found == false)); i++) {
                if (tob[i].key == u[2]) { tob[i].count++; found = true; }
              }
              if (found == false) {
                i = tob.length;
                tob[i] = {};
                tob[i].key = u[2];
                tob[i].count = 1;
              }
            }
            
            for (i = 0; i < tob.length; i++) {
              result += "date: " + tob[i].key + ", count = " + tob[i].count + "\n";
            }
            
          }
		  
		  if (comp_mode == 3) {
			// Vorlage: id: 201052, timestamp: 2015-10-05 00:17:08, content: TESTFINISH: CID:(MATHEV4YSCORM_ybeta_kit;;1002beta;;mintkolleg_kit), user:(MATHEV4YSCORM_ybeta_kit;;1002beta;;mintkolleg_kit)_SCORM_640912,
			// timestamp:1443997028764, testname:Abschlusstest Modul 5, nPoints:40, maxPoints:92, ratio:0.43478260869565216, nMinPoints:1 FROM 95.113.209.43
			
			var tid = new Array();
			var gid = new Array();
            var rex = /id: \d+, timestamp: \d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d, content: TESTFINISH: CID:\(MATHEV4YSCORM_ybeta_kit;;1002beta;;mintkolleg_kit\), user:\(MATHEV4YSCORM_ybeta_kit;;1002beta;;mintkolleg_kit\)_SCORM_(\d+), timestamp:\d+, testname:([^,]+), nPoints:(\d+), maxPoints:(\d+), ratio:[^,]+, nMinPoints:\d+ FROM/g ;
            result = "";
            var i = 0;
			var tu;
            while ( (u = rex.exec(s)) != null) {
				var found = false;
				for (i = 0; ((i < gid.length) & (found == false)); i++) {
					if (gid[i].testid == u[2]) {
						found = true;
						tu = i;
					}
				}
              
				if (found == false) {
					i = gid.length;
					gid[i] = {};
					gid[i].testid = u[2];
					gid[i].count = 0;
					gid[i].max = u[4];
					gid[i].ratio = 0;
					tu = i;
				}


				found = false;
				for (i = 0; ((i < tid.length) & (found == false)); i++) {
					if ((tid[i].userid == u[1]) && (tid[i].testid == u[2])) {
						tid[i].points = (tid[i].points > u[3]) ? tid[i].points : u[3];
						tid[i].count++;
						found = true;
					}
				}
				if (found == false) {
					i = tid.length;
					tid[i] = {};
					tid[i].userid = u[1];
					tid[i].testid = u[2];
					tid[i].count = 1;
					tid[i].points = u[3];
					tid[i].max = u[4];
					tid[i].tu = tu;
				}


			}
			
			var j;
			// compute relative point ratio frequencies
			for (i = 0; i < tid.length; i++) {
				gid[tid[i].tu].ratio += ((1.0*tid[i].points) / tid[i].max);
				gid[tid[i].tu].count++;
			}
			
			for (j = 0; j < gid.length; j++) {
				gid[j].ratio /= gid[j].count;
                result += "test-id: " + gid[j].testid + ", max " + gid[j].max + ", count = " + gid[j].count + ", ratio = " + gid[j].ratio + "\n";
			}

            /*
			for (i = 0; i < uid.length; i++) {
              result += "userid: " + uid[i].key + ", count = " + uid[i].count + "\n";
            }
			*/

			for (i = 0; i < tid.length; i++) {
              result += "user/test-id: " + tid[i].userid + ", " + tid[i].testid + ", points = " + tid[i].points + ", of " + tid[i].max + ", tries = " + tid[i].count + "\n";
			}
			
			result += tid.length + " user/tests found\n";

		  }
          
          replaceUsers();          
        }
        
        
        function replaceUsers() {
          result = result.replace(/172.22.191.10/g,"[ARBEITSPLATZ DANIEL]");
          result = result.replace(/94.217.52.117/g,"[HEIMPLATZ DANIEL]");
          result = result.replace(/172.22.191./g,"MINTKOLLEGKIT.");
          result = result.replace(/129.143.71./g,"CARL-ENGLER-SCHULE.");
          }
        
        function compute(n) {
          comp_mode = n;

            function OnSuccess(reply) {
                aftertime = +new Date();
                var o = document.getElementById("I_output");
                o.value = " - Berechnung wird ausgewertet - ";
                var duration = aftertime - beforetime;
                var ot = "Bearbeitungsdauer: " + duration + "ms (" + (duration / 1000) + " Sekunden)\n";
                parse(reply);
                ot = ot + result + "\n\n";        
                ot = ot + "\n\nRoh-Ausgabe vom Server " + server_name + call_name + ":\n";
                o.value = ot;
                ot = ot + reply + "\n\n";
                o.value = ot;
            }

            function OnError(httpRequest, textStatus, errorThrown ) {
                console.log("Error callback: " + textStatus + ", thrown: " + errorThrown);
                aftertime = +new Date();
                var o = document.getElementById("I_output");
                o.value = " - Berechnung wird ausgewertet - ";
                var duration = aftertime - beforetime;
                var ot = "Bearbeitungsdauer: " + duration + "ms (" + (duration / 1000) + " Sekunden)\n";
                ot = ot + "Fehler-Handler aufgerufen vom Server " + server_name + ": " + textStatus + ", thrown: " + errorThrown + "\n";
                o.value = ot;
            }

            document.getElementById("I_output").value = " - Berechnung läuft -";

            
            
            var like = document.getElementById("I_kuerzel").value;
            var pw = document.getElementById("I_pw").value;

            
            if (comp_mode == 2) {
              like = "%INTERSITEFIRST%";
            }

            if (comp_mode == 3) {
			  like = "%MATHEV4YSCORM_ybeta_kit%";
			}
		   
		   
            jQuery.support.cors = true;

            beforetime = +new Date();

            $.ajax( callurl, {
                type: "GET",
                cache: false,
                contentType: 'application/x-www-form-urlencoded',
                crossDomain: true,
                data: {likestring: like, password: pw},
                //dataType: 'html', //Erwarteter Datentyp der Antwort
                success: OnSuccess,
                error: OnError
            });


        }


    </script> 

    

</body>
</html>
